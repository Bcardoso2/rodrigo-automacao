// server.js - IA ECON√îMICA COM MELHORIAS (Gasta o m√≠nimo poss√≠vel)
const express = require('express');
const bodyParser = require('body-parser');
const crypto = require('crypto');
const { 
  default: makeWASocket, 
  DisconnectReason, 
  useMultiFileAuthState,
  fetchLatestBaileysVersion 
} = require('@whiskeysockets/baileys');
const { Boom } = require('@hapi/boom');
const pino = require('pino');
const fs = require('fs');
const OpenAI = require('openai');
const QRCode = require('qrcode');

const app = express();
const PORT = process.env.PORT || 3000;

// Configura√ß√µes
const WEBHOOK_SECRET = process.env.WEBHOOK_SECRET || 'YOUR_SECRET_TOKEN'; // <-- MUDE AQUI
const AUTH_FOLDER = './baileys_auth';
const OPENAI_API_KEY = process.env.OPENAI_API_KEY || 'sua-chave-aqui'; // <-- MUDE AQUI
const DB_FILE = './database.json';

// ESTRAT√âGIA DE ECONOMIA:
// 1. Usa gpt-3.5-turbo (10x mais barato que GPT-4)
// 2. Mant√©m hist√≥rico curto (s√≥ √∫ltimas 6 mensagens)
// 3. Respostas limitadas a 150 tokens
// 4. Usa respostas prontas quando poss√≠vel
// 5. IA s√≥ entra quando necess√°rio

const openai = new OpenAI({ apiKey: OPENAI_API_KEY });

if (!fs.existsSync(AUTH_FOLDER)) {
  fs.mkdirSync(AUTH_FOLDER, { recursive: true });
}

// Estado WhatsApp
let sock = null;
let qrCode = null;
let qrCodeDataURL = null;
let isConnected = false;
let connectionAttempts = 0;
const MAX_ATTEMPTS = 3;

// Banco de dados
const database = {
  customers: new Map(),
  orders: new Map(),
  conversations: new Map(),
  aiConversations: new Map(),
  activeChats: new Map(),
  pendingPixPayments: new Map() // NOVO: Controlar PIX pendentes
};

// Rate Limiting
const messageTimestamps = new Map();

// PRODUTOS (ATUALIZADO PARA AUTOGIRO)
const PRODUCTS = {
  vip: {
    id: 'vip',
    name: 'Comunidade VIP Autogiro',
    price: 79.90,
    description: 'Acesso a 100+ ofertas di√°rias de carros/motos at√© 40% abaixo da FIPE.',
    link: 'https://pay.kiwify.com.br/qAAxyjd' // SEU LINK ATUALIZADO
  }
};

// Middleware
app.use(bodyParser.json());
app.use(express.static('public'));

// ===== PERSIST√äNCIA DE DADOS =====
function loadDatabase() {
  try {
    if (fs.existsSync(DB_FILE)) {
      const data = JSON.parse(fs.readFileSync(DB_FILE, 'utf8'));
      database.customers = new Map(data.customers || []);
      database.orders = new Map(data.orders || []);
      database.conversations = new Map(data.conversations || []);
      database.pendingPixPayments = new Map(data.pendingPixPayments || []);
      console.log('üíæ Database carregado');
    }
  } catch (error) {
    console.error('‚ùå Erro ao carregar DB:', error);
  }
}

function saveDatabase() {
  try {
    const data = {
      customers: Array.from(database.customers.entries()),
      orders: Array.from(database.orders.entries()),
      conversations: Array.from(database.conversations.entries()),
      pendingPixPayments: Array.from(database.pendingPixPayments.entries())
    };
    fs.writeFileSync(DB_FILE, JSON.stringify(data, null, 2));
    console.log('üíæ Database salvo');
  } catch (error) {
    console.error('‚ùå Erro ao salvar DB:', error);
  }
}

// Auto-save a cada 2 minutos
setInterval(saveDatabase, 120000);

// Salvar ao fechar
process.on('SIGINT', () => {
  console.log('\nüõë Encerrando...');
  saveDatabase();
  process.exit(0);
});

// ===== RATE LIMITING =====
function checkRateLimit(phone) {
  const now = Date.now();
  const timestamps = messageTimestamps.get(phone) || [];
  
  // Remove mensagens antigas (>1 minuto)
  const recent = timestamps.filter(t => now - t < 60000);
  
  if (recent.length >= 10) {
    console.log(`‚ö†Ô∏è Rate limit: ${phone}`);
    return false;
  }
  
  recent.push(now);
  messageTimestamps.set(phone, recent);
  return true;
}

// ===== FUN√á√ïES DE FORMATA√á√ÉO DE TELEFONE =====

/**
 * Gera varia√ß√µes do n√∫mero de telefone (com e sem 9¬∫ d√≠gito)
 * @param {string} phone - N√∫mero original
 * @returns {Array<string>} - Array com varia√ß√µes do n√∫mero
 */
function getPhoneVariations(phone) {
  // Limpa o n√∫mero
  let cleanPhone = phone.replace(/\D/g, '');
  
  // Remove c√≥digo do pa√≠s se existir
  if (cleanPhone.startsWith('55')) {
    cleanPhone = cleanPhone.substring(2);
  }
  
  // Se tiver 11 d√≠gitos (DDD + 9 + 8 d√≠gitos)
  if (cleanPhone.length === 11 && cleanPhone[2] === '9') {
    const ddd = cleanPhone.substring(0, 2);
    const withoutNine = ddd + cleanPhone.substring(3); // Remove o 9
    return [
      '55' + cleanPhone,      // Com 9¬∫ d√≠gito
      '55' + withoutNine      // Sem 9¬∫ d√≠gito
    ];
  }
  
  // Se tiver 10 d√≠gitos (DDD + 8 d√≠gitos)
  if (cleanPhone.length === 10) {
    const ddd = cleanPhone.substring(0, 2);
    const withNine = ddd + '9' + cleanPhone.substring(2); // Adiciona o 9
    return [
      '55' + cleanPhone,      // Sem 9¬∫ d√≠gito
      '55' + withNine         // Com 9¬∫ d√≠gito
    ];
  }
  
  // Caso padr√£o: retorna com c√≥digo do pa√≠s
  if (!cleanPhone.startsWith('55')) {
    cleanPhone = '55' + cleanPhone;
  }
  
  return [cleanPhone];
}

/**
 * Envia mensagem para todas as varia√ß√µes do n√∫mero
 * @param {string} phone - N√∫mero original
 * @param {string} message - Mensagem a enviar
 */
async function sendToAllPhoneVariations(phone, message) {
  const variations = getPhoneVariations(phone);
  const results = [];
  
  console.log(`üìû Enviando para varia√ß√µes: ${variations.join(', ')}`);
  
  for (const phoneVariation of variations) {
    try {
      const success = await sendWhatsAppMessage(phoneVariation, message);
      results.push({ phone: phoneVariation, success });
      
      if (success) {
        console.log(`‚úÖ Enviado com sucesso para: ${phoneVariation}`);
      } else {
        console.log(`‚ö†Ô∏è Falha ao enviar para: ${phoneVariation}`);
      }
      
      // Aguarda 2 segundos entre envios para evitar spam
      await new Promise(resolve => setTimeout(resolve, 2000));
    } catch (error) {
      console.error(`‚ùå Erro ao enviar para ${phoneVariation}:`, error.message);
      results.push({ phone: phoneVariation, success: false });
    }
  }
  
  return results;
}

// ===== CONTROLE DE PIX PENDENTE =====

/**
 * Agenda follow-up para PIX n√£o confirmado em 5 minutos
 * @param {string} orderId - ID do pedido
 * @param {Object} customer - Dados do cliente
 * @param {Object} orderData - Dados do pedido
 */
function schedulePendingPixFollowup(orderId, customer, orderData) {
  const FIVE_MINUTES = 5 * 60 * 1000; // 5 minutos em milissegundos
  
  console.log(`‚è∞ Agendando follow-up PIX para pedido ${orderId} em 5 minutos`);
  
  // Salva o pedido pendente
  database.pendingPixPayments.set(orderId, {
    customer,
    orderData,
    createdAt: new Date(),
    followupScheduled: true
  });
  
  // Agenda o follow-up
  setTimeout(async () => {
    await handlePendingPixFollowup(orderId, customer, orderData);
  }, FIVE_MINUTES);
}

/**
 * Executa o follow-up de PIX pendente ap√≥s 5 minutos
 */
async function handlePendingPixFollowup(orderId, customer, orderData) {
  try {
    // Verifica se o pagamento foi aprovado nesse meio tempo
    const order = database.orders.get(orderId);
    if (order && order.payment_status === 'approved') {
      console.log(`‚úÖ PIX ${orderId} j√° foi pago. Follow-up cancelado.`);
      database.pendingPixPayments.delete(orderId);
      return;
    }
    
    console.log(`üì® Enviando follow-up de PIX pendente para ${customer.firstName || customer.fullName}`);
    
    const firstName = customer.firstName || 'Cliente';
    const message = `Oi ${firstName}! üëã\n\n` +
      `Notei que voc√™ gerou um PIX para a *Comunidade VIP Autogiro*, mas o pagamento ainda n√£o foi confirmado.\n\n` +
      `‚è∞ O PIX expira em breve!\n\n` +
      `Se voc√™ teve algum problema ou ficou com d√∫vida, estou aqui pra te ajudar. √â s√≥ me chamar! üòä\n\n` +
      `Caso j√° tenha pago, por favor desconsidere essa mensagem. O sistema demora alguns minutos pra confirmar. ‚úÖ`;
    
    // Envia para todas as varia√ß√µes do telefone
    if (customer.mobile) {
      await sendToAllPhoneVariations(customer.mobile, message);
    }
    
    // Remove da lista de pendentes
    database.pendingPixPayments.delete(orderId);
    saveDatabase();
    
  } catch (error) {
    console.error('‚ùå Erro no follow-up PIX:', error);
  }
}

/**
 * Cancela o follow-up quando o pagamento √© aprovado
 */
function cancelPendingPixFollowup(orderId) {
  if (database.pendingPixPayments.has(orderId)) {
    console.log(`‚úÖ Pagamento confirmado! Cancelando follow-up do pedido ${orderId}`);
    database.pendingPixPayments.delete(orderId);
    saveDatabase();
  }
}

// ===== QR CODE =====
function qrToDataURL(qr) {
  return new Promise((resolve, reject) => {
    QRCode.toDataURL(qr, { width: 300, margin: 2 }, (err, url) => {
      if (err) reject(err);
      else resolve(url);
    });
  });
}

function clearAuth() {
  try {
    if (fs.existsSync(AUTH_FOLDER)) {
      fs.rmSync(AUTH_FOLDER, { recursive: true, force: true });
      fs.mkdirSync(AUTH_FOLDER, { recursive: true });
      console.log('üßπ Auth limpa');
    }
  } catch (error) {
    console.error('‚ùå Erro:', error);
  }
}

// ===== SISTEMA H√çBRIDO: RESPOSTAS PRONTAS + IA =====

// RESPOSTAS AUTOM√ÅTICAS (ATUALIZADO COM TOM HUMANO!)
const AUTO_RESPONSES = {
  saudacao: {
    keywords: ['oi', 'ol√°', 'ola', 'hey', 'bom dia', 'boa tarde', 'boa noite', 'ola'],
    response: (name) => `Opa, ${name ? name : 'tudo bem'}? üëã\n\nAqui √© o assistente da *Autogiro*. Seja bem-vindo!\n\nN√≥s ajudamos pessoas a encontrar carros e motos com at√© 40% abaixo da FIPE (sem ser leil√£o e com laudo aprovado!).\n\nComo posso te ajudar hoje? üòä`
  },

  info_produto: {
    keywords: ['produtos', 'produto', 'o que vende', 'op√ß√µes', 'catalogo', 'pre√ßo', 'preco', 'valor', 'quanto custa', 'comprar', 'quero', 'link', 'assinar', 'vip', 'como funciona', 'me interessa'],
    response: () => `Claro! N√≥s temos a *Comunidade VIP Autogiro*. üíé\n\nFunciona assim: voc√™ entra no grupo e recebe mais de *40 ofertas todos os dias* de carros e motos com descontos absurdos (at√© 40% abaixo da FIPE).\n\nüí∞ O valor normal √© R$ 199,90, mas hoje est√° por apenas *R$ 79,90 por m√™s*.\n\nE o melhor:\n‚úÖ S√£o carros bons (todos com Laudo Cautelar)\n‚úÖ Nosso time negocia pra voc√™\n‚úÖ *Sem fidelidade*, voc√™ pode sair quando quiser.\n\nO link pra entrar √© este aqui: \n${PRODUCTS.vip.link}\n\nFicou alguma d√∫vida? S√≥ mandar!`
  },
  
  origem_carros: {
    keywords: ['de onde vem', 'fonte', 'origem', 'retomada', 'financiamento'],
    response: () => `Essa √© a m√°gica do neg√≥cio! ü™Ñ\n\nN√≥s temos acesso direto √† *fonte prim√°ria* de ve√≠culos de retomada de financiamento. S√£o carros que nem chegam a ir para o mercado ou leil√£o, por isso o pre√ßo √© t√£o bom. üöó`
  },
  
  leilao_sinistro: {
    keywords: ['leil√£o', 'leilao', 'sinistro', 'batido', 'batida', 'problema'],
    response: () => `Aqui n√£o! Pode ficar 100% tranquilo. \n\n*N√ÉO* trabalhamos com leil√£o nem com carros sinistrados (aqueles que j√° tiveram batidas feias ou problemas s√©rios).\n\nNosso foco √© s√≥ em carro bom e de proced√™ncia. üëç`
  },

  seguranca: {
    keywords: ['seguro', 'garantia', 'laudo', 'cautelar', 'confiar', 'confi√°vel', 'confiavel'],
    response: () => `Com certeza. Seguran√ßa aqui √© regra n√∫mero 1. üõ°Ô∏è\n\nFunciona assim: *NENHUM* carro √© comprado antes de ter um *Laudo Cautelar APROVADO*.\n\nVoc√™ sempre recebe o laudo e todas as fotos antes de tomar qualquer decis√£o. Transpar√™ncia total! üòâ`
  },

  fidelidade: {
    keywords: ['fidelidade', 'contrato', 'cancelar', 'sem fidelidade', 'multa'],
    response: () => `N√£o, de jeito nenhum! ü•≥\n\nAqui voc√™ tem liberdade total. Voc√™ pode cancelar a assinatura no momento que quiser, sem multa e sem nenhuma burocracia. O risco √© zero. `
  },

  iniciante: {
    keywords: ['iniciante', 'ajuda', 'suporte', 'primeira vez', 'como fa√ßo'],
    response: () => `Com certeza! A comunidade √© perfeita pra quem t√° come√ßando.\n\nVoc√™ n√£o fica sozinho. Temos um *atendimento humanizado* no WhatsApp que vai te pegar pela m√£o e ajudar em tudo: analisar o laudo, negociar o valor, at√© a entrega do carro. ü§ù`
  },
  
  frequencia: {
    keywords: ['frequencia', 'quantas ofertas', 'quando', 'todo dia', 'hor√°rio'],
    response: () => `Toda semana, de *Ter√ßa a S√°bado*, o grupo ferve! üî•\n\nS√£o mais de 40 novas oportunidades todos os dias pra voc√™ analisar.`
  },

  comissao_taxas: {
    keywords: ['comiss√£o', 'comissao', 'taxa', 'custo adicional', 'cobram', 'outros custos', 'valor extra'],
    response: () => `Boa pergunta! Transpar√™ncia √© fundamental. üìä\n\n*Custos da Autogiro:*\n\n1Ô∏è‚É£ *Assinatura mensal:* R$ 79,90 (acesso √†s ofertas)\n\n2Ô∏è‚É£ *Comiss√£o por carro arrematado:* 4% sobre o valor do ve√≠culo\n\nExemplo pr√°tico:\n‚Ä¢ Carro arrematado por R$ 30.000\n‚Ä¢ Comiss√£o = R$ 1.200 (4%)\n‚Ä¢ Total investido: R$ 31.200\n\nüí° Mesmo com a comiss√£o, voc√™ ainda economiza MUITO, j√° que os descontos chegam a 40% da FIPE!\n\nAlguma d√∫vida sobre os custos?`
  }
};


// Detectar inten√ß√£o (sem custo de IA)
function detectIntent(message) {
  const lowerMsg = message.toLowerCase().trim();
  
  for (const [intent, data] of Object.entries(AUTO_RESPONSES)) {
    if (data.keywords.some(keyword => lowerMsg.includes(keyword))) {
      return intent;
    }
  }
  
  // Detectar se est√° escolhendo produto (n√£o se aplica mais tanto, mas mantemos)
  if (/^[1-3]$/.test(lowerMsg)) {
    return 'escolha_produto';
  }
  
  return null; // N√£o identificado = vai para IA
}

// Handler de escolha de produto
function handleProductSelection(choice, customerData = {}) {
  // Adaptado para produto √∫nico
  const product = PRODUCTS.vip;
  
  const name = customerData.firstName ? ` ${customerData.firstName}` : '';
  
  return `üéØ *${product.name}*${name}!\n\n` +
    `${product.description}\n\n` +
    `üí∞ Investimento: *R$ ${product.price}*\n` +
    `üîó *Link de pagamento:*\n${product.link}\n\n` +
    `‚úÖ Acesso liberado automaticamente ap√≥s aprova√ß√£o!\n` +
    `üõ°Ô∏è Sem fidelidade - cancele quando quiser!\n\n` +
    `Qualquer d√∫vida, estou aqui! üòä`;
}

// Gerar resposta autom√°tica
function getAutoResponse(intent, customerData = {}, message = '') {
  if (intent === 'escolha_produto') {
    // Se digitou "1", "2" ou "3", apenas mande o link principal
    return handleProductSelection('1', customerData);
  }
  
  const responseData = AUTO_RESPONSES[intent];
  if (!responseData) return null;
  
  return responseData.response(customerData.firstName);
}

// ===== IA ECON√îMICA (s√≥ quando necess√°rio) =====

// Prompt CURTO para economizar tokens (ATUALIZADO AUTOGIRO)
const AI_SYSTEM_PROMPT = `Voc√™ √© um especialista em vendas da Autogiro. Seja breve, direto e confi√°vel.

PRODUTO √öNICO:
- Nome: Comunidade VIP Autogiro
- Pre√ßo: R$ 79,90/m√™s (Promocional)
- O que √©: Acesso a 100+ ofertas di√°rias de carros/motos (at√© 40% abaixo da FIPE).
- N√ÉO √â LEIL√ÉO. √â retomada de financiamento (fonte prim√°ria).
- √â SEGURO. Tudo tem Laudo Cautelar antes da compra.
- N√ÉO TEM FIDELIDADE. Cancela quando quiser.

CUSTOS ADICIONAIS:
- Assinatura: R$ 79,90/m√™s
- Comiss√£o: 4% sobre o valor do ve√≠culo arrematado
- Exemplo: Carro de R$ 30.000 = comiss√£o de R$ 1.200

OBJETIVO: Tirar d√∫vidas e convencer o cliente a assinar.

REGRAS IMPORTANTES:
- Seja consultivo e gere confian√ßa.
- Respostas curtas (m√°ximo 3-4 linhas).
- Reforce sempre: "N√£o √© leil√£o" e "Tem laudo cautelar".
- Quando perguntarem sobre custos, seja transparente sobre a comiss√£o de 4%.
- Se cliente estiver pronto para comprar, envie: [LINK_VIP]
- Use emojis de forma profissional (üöó, üõ°Ô∏è, üíé, ‚úÖ, üí∞).`;

// Chamar IA (APENAS quando necess√°rio)
async function getAIResponse(customerPhone, customerMessage, customerData = {}) {
  try {
    console.log('üí∞ Chamando IA (custo estimado: $0.0001)');
    
    // Hist√≥rico CURTO (√∫ltimas 6 msgs = economia!)
    let history = database.aiConversations.get(customerPhone) || [];
    if (history.length > 6) {
      history = history.slice(-6);
    }

    // Contexto m√≠nimo
    let context = customerData.firstName ? `Cliente: ${customerData.firstName}` : '';
    
    history.push({
      role: 'user',
      content: context ? `${context}\n${customerMessage}` : customerMessage
    });

    const completion = await openai.chat.completions.create({
      model: 'gpt-3.5-turbo', // 10x mais barato que GPT-4!
      messages: [
        { role: 'system', content: AI_SYSTEM_PROMPT },
        ...history
      ],
      temperature: 0.7,
      max_tokens: 150, // Respostas curtas = economia
      presence_penalty: 0.3,
      frequency_penalty: 0.3
    });

    const aiResponse = completion.choices[0].message.content;
    
    history.push({
      role: 'assistant',
      content: aiResponse
    });

    database.aiConversations.set(customerPhone, history);

    // Substituir placeholders por links
    let response = aiResponse
      .replace(/\[LINK_VIP\]/g, PRODUCTS.vip.link)
      .replace(/\[LINK_CURSO\]/g, PRODUCTS.vip.link) // Fallback
      .replace(/\[LINK_MENTORIA\]/g, PRODUCTS.vip.link); // Fallback

    return response;

  } catch (error) {
    console.error('‚ùå Erro IA:', error.message);
    return 'Desculpe, tive um problema t√©cnico. Pode repetir sua pergunta? üòÖ';
  }
}

// ===== ROTEADOR INTELIGENTE (decide: AUTO ou IA) =====
async function getSmartResponse(customerPhone, customerMessage, customerData = {}) {
  // 1. Tenta resposta autom√°tica PRIMEIRO (SEM CUSTO!)
  const intent = detectIntent(customerMessage);
  
  if (intent) {
    const autoResponse = getAutoResponse(intent, customerData, customerMessage);
    if (autoResponse) {
      console.log('‚úÖ Resposta autom√°tica (custo: R$ 0,00)');
      return autoResponse;
    }
  }

  // 2. Se n√£o achou, usa IA (COM CUSTO M√çNIMO)
  console.log('ü§ñ Usando IA para conversa...');
  return await getAIResponse(customerPhone, customerMessage, customerData);
}

// ===== HANDLER DE MENSAGENS =====
async function handleIncomingMessage(from, text, fullMessage) {
  try {
    const cleanPhone = from.replace('@s.whatsapp.net', '');
    
    // Rate limiting
    if (!checkRateLimit(cleanPhone)) {
      await sock.sendMessage(from, { 
        text: 'Por favor, aguarde um momento antes de enviar mais mensagens. üòä' 
      });
      return;
    }
    
    // Buscar dados do cliente
    let customerData = {};
    for (const customer of database.customers.values()) {
      if (customer.mobile && customer.mobile.replace(/\D/g, '').includes(cleanPhone)) {
        customerData = customer;
        break;
      }
    }

    console.log(`\nüì® Mensagem de ${customerData.firstName || cleanPhone}`);
    console.log(`üí¨ "${text}"`);

    // Marcar como digitando
    await sock.sendPresenceUpdate('composing', from);

    // Obter resposta inteligente
    const response = await getSmartResponse(cleanPhone, text, customerData);

    // Aguardar 1-2 segundos (parece humano)
    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));

    // Enviar resposta
    await sock.sendMessage(from, { text: response });
    
    console.log(`‚úÖ Respondido: "${response.substring(0, 50)}..."`);

    // Salvar conversa
    const conversation = database.conversations.get(from) || {
      phone: cleanPhone,
      messages: [],
      createdAt: new Date()
    };
    
    conversation.messages.push(
      { from: 'customer', text, timestamp: new Date() },
      { from: 'bot', text: response, timestamp: new Date() }
    );
    
    database.conversations.set(from, conversation);

  } catch (error) {
    console.error('‚ùå Erro ao responder:', error);
    try {
      await sock.sendMessage(from, { 
        text: 'Ops, tive um problema. Pode tentar de novo? üòÖ' 
      });
    } catch (e) {}
  }
}

// ===== CONECTAR WHATSAPP =====
async function connectToWhatsApp() {
  try {
    connectionAttempts++;
    console.log(`\nüîÑ Conex√£o #${connectionAttempts}...`);
    
    if (connectionAttempts > MAX_ATTEMPTS) {
      console.log('‚ö†Ô∏è Limpando auth...');
      clearAuth();
      connectionAttempts = 0;
    }

    const { state, saveCreds } = await useMultiFileAuthState(AUTH_FOLDER);
    
    let version;
    try {
      const versionInfo = await fetchLatestBaileysVersion();
      version = versionInfo.version;
      console.log('üì¶ Baileys:', version.join('.'));
    } catch (error) {
      version = [2, 3000, 0];
    }

    sock = makeWASocket({
      version,
      logger: pino({ level: 'silent' }),
      printQRInTerminal: true,
      auth: state,
      browser: ['Rob√¥ Autogiro', 'Chrome', '1.0.0'],
      defaultQueryTimeoutMs: undefined,
      getMessage: async (key) => ({ conversation: '' })
    });

    sock.ev.on('connection.update', async (update) => {
      const { connection, lastDisconnect, qr } = update;

      if (qr) {
        qrCode = qr;
        connectionAttempts = 0;
        try {
          qrCodeDataURL = await qrToDataURL(qr);
          console.log('\n‚úÖ QR CODE GERADO');
          console.log('üì± http://localhost:' + PORT + '/qr\n');
        } catch (error) {
          console.error('‚ùå Erro QR:', error);
        }
      }

      if (connection === 'close') {
        isConnected = false;
        qrCode = null;
        qrCodeDataURL = null;
        
        const statusCode = lastDisconnect?.error?.output?.statusCode;
        const shouldReconnect = statusCode !== DisconnectReason.loggedOut;

        if (statusCode === DisconnectReason.loggedOut) {
          clearAuth();
        }

        if (shouldReconnect) {
          setTimeout(connectToWhatsApp, 3000);
        }
      } 
      else if (connection === 'open') {
        console.log('\n‚úÖ WHATSAPP CONECTADO');
        console.log('üì±', sock.user?.id);
        console.log('ü§ñ Bot IA Autogiro ativo!\n');
        
        isConnected = true;
        qrCode = null;
        qrCodeDataURL = null;
        connectionAttempts = 0;
      }
    });

    sock.ev.on('creds.update', saveCreds);
    sock.ev.on('messages.upsert', async ({ messages }) => {
      const msg = messages[0];
      if (!msg.message || msg.key.fromMe) return;

      const from = msg.key.remoteJid;
      const text = msg.message.conversation || 
                   msg.message.extendedTextMessage?.text || '';

      if (text) {
        await handleIncomingMessage(from, text, msg);
      }
    });

  } catch (error) {
    console.error('\n‚ùå Erro:', error);
    setTimeout(connectToWhatsApp, 5000);
  }
}

// ===== WEBHOOK FUNCTIONS =====
function verifySignature(body, signature) {
  const calculatedSignature = crypto
    .createHmac('sha1', WEBHOOK_SECRET)
    .update(JSON.stringify(body))
    .digest('hex');
  return signature === calculatedSignature;
}

function saveCustomer(customerData, orderData) {
  const customerId = customerData.email;
  const customer = {
    email: customerData.email,
    fullName: customerData.full_name || customerData.fullName,
    firstName: customerData.first_name || customerData.firstName,
    mobile: customerData.mobile || customerData.phone,
    cpf: customerData.CPF || customerData.cpf,
    lastOrder: orderData.order_id || orderData.id,
    createdAt: database.customers.has(customerId) 
      ? database.customers.get(customerId).createdAt 
      : new Date(),
    updatedAt: new Date(),
    orders: [
      ...(database.customers.get(customerId)?.orders || []),
      orderData.order_id || orderData.id
    ]
  };
  database.customers.set(customerId, customer);
  return customer;
}

function saveOrder(orderData) {
  database.orders.set(orderData.order_id, {
    ...orderData,
    savedAt: new Date()
  });
}

// ATUALIZADO COM LINK DE SUPORTE
function generateMessage(eventType, customer, orderData) {
  const firstName = customer.firstName || 'Cliente';
  const productName = orderData.Product?.product_name || 'Comunidade VIP';
  
  // Link direto para o seu Rob√¥ de Suporte Autogiro
  const linkSuporte = 'https://wa.me/5512996232861'; 

  const messages = {
    order_approved: {
      text: `üéâ *Parab√©ns ${firstName}!*\n\n` +
        `Sua compra da *${productName}* foi aprovada!\n\n` +
        
        // 1. Link de Acesso √† Plataforma (vem da Kiwify)
        `‚úÖ *Acesse a plataforma aqui:*\n${orderData.access_url || 'Em breve voc√™ receber√° o acesso por e-mail'}\n\n` + 
        
        `--- \n\n` +
        
        // 2. Link para o Rob√¥ de Suporte
        `ü§ñ *SUPORTE AUTOGIRO*\n` +
        `Agora, para qualquer d√∫vida sobre o produto ou sobre as ofertas, por favor, chame nosso *Rob√¥ de Suporte*.\n\n` +
        `*Acesse o link:*\nüëâ ${linkSuporte}\n\n` +
        `Basta clicar e enviar um "Ol√°" para o nosso time de suporte! üëã`
    },
    abandoned_cart: {
      text: `Oi ${firstName}! üëã\n\n` +
        `Vi que voc√™ deixou *${productName}* no carrinho.\n\n` +
        `Posso te ajudar com alguma d√∫vida? üòä`
    },
    pix_generated: {
      text: `Oi ${firstName}! üëã\n\n` +
        `Vi que voc√™ gerou um PIX para a *${productName}*! üéâ\n\n` +
        `‚ö†Ô∏è *Importante:* O PIX tem prazo de validade.\n\n` +
        `Assim que efetuar o pagamento, seu acesso ser√° liberado automaticamente! ‚úÖ\n\n` +
        `Qualquer d√∫vida, estou aqui pra ajudar! üòä`
    }
  };
  return messages[eventType] || messages.order_approved;
}


async function sendWhatsAppMessage(phone, message) {
  try {
    if (!isConnected || !sock) {
      console.log('‚ö†Ô∏è WhatsApp n√£o conectado');
      return false;
    }

    let formattedPhone = phone.replace(/[^\d]/g, '');
    if (!formattedPhone.startsWith('55')) {
      formattedPhone = '55' + formattedPhone;
    }
    const jid = formattedPhone + '@s.whatsapp.net';

    await sock.sendMessage(jid, { text: message });
    console.log(`‚úÖ Enviado para ${phone}`);
    return true;
  } catch (error) {
    console.error(`‚ùå Erro envio:`, error.message);
    return false;
  }
}

async function startConversation(eventType, customer, orderData) {
  const messageData = generateMessage(eventType, customer, orderData);
  
  console.log('\nüì± NOVO EVENTO:', eventType);
  console.log('Cliente:', customer.fullName);
  
  if (customer.mobile && isConnected) {
    // Para carrinho abandonado, envia para todas varia√ß√µes
    if (eventType === 'abandoned_cart') {
      console.log('üîÑ Enviando para todas as varia√ß√µes do n√∫mero (com/sem 9¬∫ d√≠gito)');
      await sendToAllPhoneVariations(customer.mobile, messageData.text);
    } 
    // Para PIX gerado, agenda follow-up mas N√ÉO envia mensagem inicial
    else if (eventType === 'pix_generated') {
      console.log('‚è∞ PIX gerado - agendando follow-up em 5 minutos');
      schedulePendingPixFollowup(orderData.order_id, customer, orderData);
      // Opcionalmente, enviar confirma√ß√£o de PIX gerado:
      await sendWhatsAppMessage(customer.mobile, messageData.text);
    }
    // Para compra aprovada, cancela follow-up e envia confirma√ß√£o
    else if (eventType === 'order_approved') {
      cancelPendingPixFollowup(orderData.order_id);
      await sendWhatsAppMessage(customer.mobile, messageData.text);
    }
    // Outros eventos
    else {
      await sendWhatsAppMessage(customer.mobile, messageData.text);
    }
  } else {
    console.log('‚ö†Ô∏è Telefone n√£o dispon√≠vel ou WhatsApp offline');
  }
}

// ===== ENDPOINTS =====
app.post('/webhook', async (req, res) => {
  try {
    const { signature } = req.query;
    
    if (!verifySignature(req.body, signature)) {
      return res.status(400).json({ error: 'Invalid signature' });
    }
    
    const webhookData = req.body;
    let eventType = webhookData.webhook_event_type || 'order_approved';
    
    // üî¥ NOVO: Detectar pedido recusado
    // OPCIONAL: Oferecer suporte ap√≥s rejei√ß√£o
if (webhookData.order_status === 'refused') {
  const customer = saveCustomer(webhookData.Customer, webhookData);
  const supportMessage = 
    `Oi ${customer.firstName || 'Cliente'}! üëã\n\n` +
    `Notei que houve um problema com o pagamento da *Comunidade VIP Autogiro*.\n\n` +
    `üî¥ Motivo: Recusado pelo banco\n\n` +
    `Se precisar de ajuda para tentar novamente ou quiser usar outra forma de pagamento, ` +
    `√© s√≥ me chamar! Estou aqui pra te ajudar. üòä\n\n` +
    `Link para nova tentativa:\n${PRODUCTS.vip.link}`;
  
  if (customer.mobile && isConnected) {
    await sendWhatsAppMessage(customer.mobile, supportMessage);
  }
  
  saveOrder(webhookData);
  return res.status(200).json({ 
    status: 'ok',
    event_type: 'order_rejected_with_support',
    message: 'Mensagem de suporte enviada'
  });
}
    
    // PIX gerado
    if (eventType === 'order_created' && webhookData.payment_method === 'pix') {
      eventType = 'pix_generated';
    }
    
    // Pagamento aprovado
    if (webhookData.payment_status === 'approved' || 
        webhookData.order_status === 'paid') {
      eventType = 'order_approved';
    }
    
    const customer = saveCustomer(webhookData.Customer, webhookData);
    saveOrder(webhookData);
    await startConversation(eventType, customer, webhookData);
    
    return res.status(200).json({ 
      status: 'ok',
      event_type: eventType,
      whatsapp_connected: isConnected
    });
  } catch (error) {
    console.error('‚ùå Webhook error:', error);
    return res.status(500).json({ error: error.message });
  }
});

app.get('/qr', (req, res) => {
  if (qrCodeDataURL) {
    res.send(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>QR Code WhatsApp</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="refresh" content="5">
        <style>
          body{font-family:sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#25D366,#128C7E);margin:0}
          .container{background:#fff;padding:2rem;border-radius:20px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.3)}
          h1{color:#25D366;margin-bottom:1rem}
          img{width:300px;height:300px;border-radius:10px}
          .timer{color:#666;margin-top:1rem;font-size:14px}
        </style>
      </head>
      <body>
        <div class="container">
          <h1>üì± QR Code WhatsApp</h1>
          <p>Escaneie com seu celular</p>
          <img src="${qrCodeDataURL}">
          <p class="timer">‚è∞ Atualizando em <span id="t">5</span>s</p>
        </div>
        <script>
          let s=5;setInterval(()=>{s--;document.getElementById('t').textContent=s;if(s<=0)location.reload()},1000);
        </script>
      </body>
      </html>
    `);
  } else if (isConnected) {
    res.send(`
      <!DOCTYPE html>
      <html>
      <head><title>Conectado</title><meta name="viewport" content="width=device-width, initial-scale=1">
      <style>body{font-family:sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#25D366,#128C7E);margin:0}.box{background:#fff;padding:3rem;border-radius:20px;text-align:center}h1{color:#25D366;font-size:2rem}.emoji{font-size:5rem}</style>
      </head>
      <body><div class="box"><div class="emoji">‚úÖ</div><h1>WhatsApp Conectado!</h1><p>Bot IA Autogiro ativo</p></div></body>
      </html>
    `);
  } else {
    res.send(`
      <!DOCTYPE html>
      <html>
      <head><title>Aguardando...</title><meta http-equiv="refresh" content="2"><meta name="viewport" content="width=device-width, initial-scale=1">
      <style>body{font-family:sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#667eea,#764ba2);margin:0}.box{background:#fff;padding:3rem;border-radius:20px;text-align:center}.spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:2rem auto}@keyframes spin{100%{transform:rotate(360deg)}}</style>
      </head>
      <body><div class="box"><h1>‚è≥ Gerando QR...</h1><div class="spinner"></div></div></body>
      </html>
    `);
  }
});

app.post('/clear-auth', (req, res) => {
  clearAuth();
  res.json({ success: true, message: 'Auth limpa com sucesso' });
});

app.get('/status', (req, res) => {
  res.json({
    whatsapp_connected: isConnected,
    customers: database.customers.size,
    conversations: database.conversations.size,
    ai_conversations: database.aiConversations.size,
    pending_pix: database.pendingPixPayments.size,
    uptime: process.uptime()
  });
});

app.get('/stats', (req, res) => {
  let totalMsgs = 0;
  let aiMsgs = 0;
  
  for (const conv of database.aiConversations.values()) {
    aiMsgs += conv.length;
  }
  
  for (const conv of database.conversations.values()) {
    totalMsgs += conv.messages?.length || 0;
  }
  
  const autoMsgs = totalMsgs - aiMsgs;
  const savings = totalMsgs > 0 ? (autoMsgs / totalMsgs * 100).toFixed(1) : '0.0';
  
  res.json({
    total_messages: totalMsgs,
    auto_responses: autoMsgs,
    ai_responses: aiMsgs,
    cost_savings: `${savings}%`,
    estimated_cost: `${(aiMsgs * 0.0001).toFixed(4)}`,
    customers_count: database.customers.size,
    pending_pix_count: database.pendingPixPayments.size
  });
});

app.get('/conversations', (req, res) => {
  const convList = [];
  for (const [phone, conv] of database.conversations.entries()) {
    convList.push({
      phone: conv.phone,
      message_count: conv.messages?.length || 0,
      last_message: conv.messages?.[conv.messages.length - 1]?.timestamp || null
    });
  }
  res.json({ conversations: convList });
});

app.get('/pending-pix', (req, res) => {
  const pendingList = [];
  for (const [orderId, data] of database.pendingPixPayments.entries()) {
    pendingList.push({
      order_id: orderId,
      customer: data.customer.fullName,
      phone: data.customer.mobile,
      created_at: data.createdAt,
      followup_scheduled: data.followupScheduled
    });
  }
  res.json({ 
    pending_count: pendingList.length,
    pending_payments: pendingList 
  });
});

app.get('/', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Rob√¥ IA Autogiro - Melhorado</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:2rem}
        .container{max-width:800px;margin:0 auto;background:#fff;border-radius:20px;padding:2rem;box-shadow:0 10px 30px rgba(0,0,0,.3)}
        h1{color:#333;margin-bottom:1rem}
        .status{background:#f5f5f5;padding:1rem;border-radius:10px;margin:1rem 0}
        .item{display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid #ddd}
        .item:last-child{border:none}
        .badge{padding:.25rem .75rem;border-radius:20px;font-size:.875rem}
        .success{background:#4caf50;color:#fff}
        .danger{background:#f44336;color:#fff}
        .warning{background:#ff9800;color:#fff}
        .links{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-top:2rem}
        a{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:1.5rem;border-radius:12px;text-decoration:none;text-align:center;display:block;transition:transform .2s}
        a:hover{transform:translateY(-5px)}
        .info{background:#e3f2fd;padding:1rem;border-radius:10px;margin-top:1rem;font-size:.875rem}
        .feature{background:#f0f8ff;padding:1rem;border-radius:10px;margin-top:1rem;border-left:4px solid #2196f3}
        .feature h3{color:#2196f3;margin-bottom:.5rem;font-size:1rem}
        .feature ul{margin-left:1.5rem;margin-top:.5rem}
        .feature li{margin:.25rem 0}
      </style>
    </head>
    <body>
      <div class="container">
        <h1>ü§ñ Rob√¥ IA Autogiro - Melhorado</h1>
        <p>Sistema h√≠brido com detec√ß√£o inteligente de telefone e PIX</p>
        
        <div class="status">
          <div class="item">
            <span>WhatsApp</span>
            <span class="badge ${isConnected ? 'success' : 'danger'}">
              ${isConnected ? '‚úÖ Online' : '‚ùå Offline'}
            </span>
          </div>
          <div class="item">
            <span>Clientes</span>
            <span>${database.customers.size}</span>
          </div>
          <div class="item">
            <span>PIX Pendentes</span>
            <span class="badge ${database.pendingPixPayments.size > 0 ? 'warning' : 'success'}">
              ${database.pendingPixPayments.size}
            </span>
          </div>
          <div class="item">
            <span>Conversas IA</span>
            <span>${database.aiConversations.size}</span>
          </div>
          <div class="item">
            <span>Conversas Total</span>
            <span>${database.conversations.size}</span>
          </div>
        </div>
        
        <div class="feature">
          <h3>üéØ Novidades implementadas:</h3>
          <ul>
            <li><strong>Carrinho abandonado:</strong> Envia para AMBAS varia√ß√µes do n√∫mero (com/sem 9¬∫ d√≠gito)</li>
            <li><strong>PIX gerado:</strong> Agenda follow-up autom√°tico ap√≥s 5 minutos</li>
            <li><strong>Pagamento aprovado:</strong> Cancela follow-up e envia confirma√ß√£o</li>
            <li><strong>Detec√ß√£o inteligente:</strong> Sistema reconhece n√∫meros com 10 ou 11 d√≠gitos</li>
          </ul>
        </div>
        
        <div class="info">
          <strong>üí° Como funciona:</strong><br>
          ‚Ä¢ Respostas autom√°ticas para perguntas comuns (GR√ÅTIS)<br>
          ‚Ä¢ IA conversacional para d√∫vidas complexas (custo m√≠nimo)<br>
          ‚Ä¢ Sistema econ√¥mico com gpt-3.5-turbo<br>
          ‚Ä¢ Follow-up autom√°tico para PIX n√£o confirmado<br>
          ‚Ä¢ Envio para m√∫ltiplas varia√ß√µes de telefone
        </div>
        
        <div class="links">
          <a href="/qr">üì± Conectar</a>
          <a href="/status">üìä Status</a>
          <a href="/stats">üí∞ Economia</a>
          <a href="/conversations">üí¨ Conversas</a>
          <a href="/pending-pix">‚è∞ PIX Pendentes</a>
        </div>
      </div>
    </body>
    </html>
  `);
});

// Carregar database ao iniciar
loadDatabase();

// Iniciar servidor
app.listen(PORT, () => {
  console.log(`
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë  ü§ñ ROB√î IA AUTOGIRO - VERS√ÉO MELHORADA   ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  
  üì° Servidor: http://localhost:${PORT}
  üì± QR Code: http://localhost:${PORT}/qr
  üí∞ Stats: http://localhost:${PORT}/stats
  üí¨ Conversas: http://localhost:${PORT}/conversations
  ‚è∞ PIX Pendentes: http://localhost:${PORT}/pending-pix
  
  ‚ú® MELHORIAS IMPLEMENTADAS:
  
  1Ô∏è‚É£ CARRINHO ABANDONADO:
     ‚úÖ Envia para n√∫mero COM 9¬∫ d√≠gito
     ‚úÖ Envia para n√∫mero SEM 9¬∫ d√≠gito
     ‚úÖ Exemplo: 91989204297 e 9189204297
  
  2Ô∏è‚É£ PIX GERADO:
     ‚úÖ Agenda follow-up em 5 minutos
     ‚úÖ Envia lembrete se pagamento n√£o confirmado
     ‚úÖ Cancela automaticamente se pago
  
  3Ô∏è‚É£ PAGAMENTO APROVADO:
     ‚úÖ Cancela follow-up pendente
     ‚úÖ Envia confirma√ß√£o de compra
     ‚úÖ Link de acesso + suporte
  
  üí° ESTRAT√âGIA DE ECONOMIA:
  ‚úÖ Respostas autom√°ticas (gr√°tis)
  ‚úÖ IA apenas quando necess√°rio
  ‚úÖ gpt-3.5-turbo (10x mais barato)
  ‚úÖ Hist√≥rico curto (economia de tokens)
  ‚úÖ Rate limiting (10 msgs/min)
  ‚úÖ Persist√™ncia em arquivo JSON
  
  üöÄ PRONTO PARA USO!
  `);
  
  // Conectar ao WhatsApp
  connectToWhatsApp();
});
